---
title: "Dive Planification"
author: "Maxime Jaunatre"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Dive Planification}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 6.1,
  fig.width = 8.5,
  dpi = 96
)
#library(details)
library(viridisLite)
```

The package `{DiveR}` provide functions to simulate a dive. It does so by asking a depth, a time and few parameters. This vignette will demonstrate the workflow to simulate a simple dive and different models of two-dives systems.

**Note here that it only show square dives, meaning that decompression is managed following mn90 (french) dive tables.**

## Simple Dive

To simulate a simple dive using tables, you just need to provide a depth (meter) and a time (minute) at this depth. Despite being an altitude below 0, the depth must be set in positive values in the package.

```{r basic_dive,  dev='png', out.width="100%"}
library(DiveR)
dive20_40 <- dive(depth = 20, time = 40)
plot(dive20_40, line_print = FALSE)
```

This object of class dive contain a time/depth curve, information about the desaturation process and more information about the parameters used and other results that will be used in plots or other simulations.

The default parameters worth noting are :
* `secu = TRUE` adding a default security stop at 3m for 3min
*`desat_model` The desaturation model used. This vignette will only show `table` model (mn90 french dive tables).

### Limits of table model

This precise model provide desaturation stops at 3, 6 and 9 meters depths for a given time and depth. It's important to check these two values because this table is limited to a maximum depth of 65m and time limits depending on the depth. 

```{r secu_curve,  dev='png', out.width="100%", echo = FALSE}
nodeco <- time <- depth <- 1:65
for(i in depth){
  time[i] <- max_depth_time(depth[i])
  nodeco[i] <- max_depth_time(depth[i], force = TRUE, no_deco = TRUE)
}
cols = viridis(3)
# plot(time, -depth, type = "l", xlim = c(0, max(time)), 
#      xlab = "Time (min)", ylab = "Depth (meter)", 
#      main = "Maximum time in table with desat stop (Deco) and without")
# lines(nodeco, -depth, type = "l")
# polygon(c(rep(0, length(nodeco)), rev(nodeco)), c(-depth, -rev(depth)), col = cols[2])
# polygon(c(time, rev(nodeco)), c(-depth, -rev(depth)), col = cols[1])

df <- rbind(rev(nodeco),rev(time-nodeco))
colnames(df) <- -rev(depth)
barplot(df, horiz = TRUE, col = rev(cols[-3]), yaxt = "n", 
     xlab = "Time (min)", ylab = "Depth (meter)", 
     main = "Maximum time in table with desat stop (Deco) and without")
axis(2, at = seq(0, par("usr")[4]- 3, length.out = 14), labels = seq(-65, -0, by = 5))
legend("bottomright", legend = c("No-deco time" , "Deco"), fill = rev(cols[-3]))
```


```{r lim funct, error=TRUE}
### check if in table
tablecheck(20, 50)
tablecheck(20, 80)
tablecheck(20, 80, force = TRUE)
### checking time
max_depth_time(depth = 20)
max_depth_time(depth = 20, no_deco = TRUE)
```



## Dive Methods

Now that we have simulated a dive, we may want to find more information about it, in order to dive in safety.

First we check if we can dive at the simulated depth. This is important because depth is the main parameter we have to check during a dive.

```{r ghost_dive, echo = FALSE}
ghost_dive <- dive(depth = 39, time = 22, secu = FALSE)
```

```{r depth_dive}
depth(dive20_40)
depth(ghost_dive) # it is important when depth is not in the name !
```

The second important parameter of a dive is the duration of the dive. This parameter is important to understand saturation process. The `dtime` function return the dive time at depth. **This is different from the underwater time retrieved by the difference between the immersion hour and surface hour.**

```{r dtime_dive}
dtime(dive20_40)
dtime(ghost_dive) # it is important when depth is not in the name !
# Difference with underwater time
diff(dive20_40$hour)
dtime(dive20_40) + dtr(dive20_40) == diff(dive20_40$hour)
```

Above function allow to retrieve very basic parameters. If you want to check the depth at a time or when you will be at some depth, you can ! Note that outside the dive this is assumed to be 0m.

```{r depth_time_dive}
depth_at_time(dive20_40, 15)
depth_at_time(dive20_40, 43) # during desat
depth_at_time(dive20_40, 50) # after the dive
depth_at_time(ghost_dive, 15)
```

Finally we can find all information in a summary. It also show the desaturation stop used for the dive.

```{r summary_dive}
summary(dive20_40)
summary(ghost_dive)
```


<!--
<details>
 <summary>Summary Goes Here</summary>
 ...this is hidden, collapsable content...
</details>

## Multiple Dives

### Independant Dives

### Successive Dives

### Consecutive Dives

-->


## Testing other dive style

Need to correct depth inf for these dives as well as to warning if depth > max depth desat stop because there is back to the future dive style there !
Check add_desat function !

Modification of methods too to check these objects. May be just show max time, hour, max depth

```{r dive}
library(DiveR)
dive20_40 <- dive(depth = 20, time = 40) ; plot(dive20_40)
dive39_22 <- dive(depth = 39, time = 22) ; plot(dive39_22)

diveC_20_40 <- dive(depth = c(0, 20, 20, 10, 10, 7), 
                    time = c(0, 2, 15, 20, 35,  40)) ; plot(diveC_20_40)
diveC_20_40 <- dive(depth = c(0, 20, 18, 10, 2), 
                    time = c(0, 2, 15, 20, 40)) ; plot(diveC_20_40)
dtime(diveC_20_40)
dtr(diveC_20_40)
diveC_39_22 <- dive(depth = c(0, 39, 30, 15, 7), 
                    time = c(0, 2, 7, 15, 22)) ; plot(diveC_39_22)
diveC_39_22 <- dive(depth = c(0, 39, 30, 15, 3), 
                    time = c(0, 2, 7, 15, 22)) ; plot(diveC_39_22)
```

